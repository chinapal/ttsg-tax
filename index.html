<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CN/SG Tax Calculator</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f7f9fc;
        }
        .container {
            background: #ffffff;
            padding: 20px;
            box-sizing: border-box;
        }
        h1 {
            font-size: 1.8rem;
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }
        .form-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .form-row label {
            flex: 1;
            margin-right: 10px;
            font-size: 0.9rem;
            color: #333;
        }
        .form-row input {
            flex: 2;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .result {
            font-size: 80%;
            margin: 20px -20px;
            font-size: 1rem;
            color: #444;
            text-align: left;
            background-color: #f0f8ff;
            border-radius: 5px;
            padding: 5px 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .result span {
            font-weight: bold;
            color: #333;
        }
        .references {
            margin-top: 20px;
        }
        .references ul {
            list-style-position: inside;
            padding-left: 0;
            list-style: none;
        }
        .references ul li {
            padding-bottom: 5px;
        }
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .checkbox-row input, .checkbox-row label {
            width: auto;
            margin: 0;
        }
        .checkbox-row label {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CN/SG Tax Calculator</h1>

        <div class="result">
          <p>Tax deductions, CPF, and similar factors are not included.</p>
          <p>Generated by GPT; not legally accurate. Use with caution.</p>
          <p>Calculations are performed in your browser and are not sent anywhere.
          Source code: <a href="https://github.com/chinapal/ttsg-tax">chinapal/ttsg-tax</a></p>
        </div>

        <div class="form-row">
            <label for="monthlyPay">* Monthly Base Salary (cash, in SGD):</label>
            <input type="number" id="monthlyPay" value="10000" step="1">
        </div>

        <div class="form-row">
            <label for="bonusMonths">Target Bonus (in months):</label>
            <input type="number" id="bonusMonths" value="3" step="1">
        </div>

        <div class="form-row">
            <label for="rsuSold">* RSU Sold (counts toward total income, in SGD):</label>
            <input type="number" id="rsuSold" value="50000" step="1">
        </div>

        <div class="form-row">
            <label for="compensationPercentage">* Your Tax Subsidy Ratio (%):</label>
            <input type="number" id="compensationPercentage" value="10" step="0.1">
        </div>

        <div class="form-row">
            <label for="employedDays">Employed Calendar Days (total 366 for 2024):</label>
            <input type="number" id="employedDays" value="366" step="1">
        </div>

        <div class="form-row">
            <label for="exchangeRate">Exchange Rate (SGD to CNY):</label>
            <input type="number" id="exchangeRate" value="5.39" step="0.01">
        </div>

        <div class="checkbox-row">
          <input type="checkbox" id="separatedBonusTax">
          <label for="separatedBonusTax">Separated Bonus Tax <sup>[1]</sup></label>
          <input type="checkbox" id="separatedRSUTax">
          <label for="separatedRSUTax">Separated RSU Tax <sup>[2]</sup></label>
        </div>

        <p>If you're both China & Singapore tax resident:</p>
        <div class="result" id="result">
            <p>Cash Income: <span class="amount" id="cashIncome"></span></p>
            <p>Tax Subsidy <sup>[3]</sup>: <span class="amount" id="compensation"></span></p>
            <p>Total Income <sup>[4]</sup>: <span class="amount" id="totalIncome"></span></p>
            <p>Total Tax <sup>[5]</sup>: <span class="amount" id="totalTax"></span></p>
            <p>SG Tax: <span class="amount" id="sgTax"></span></p>
            <p>CN Tax: <span class="amount" id="cnTax"></span></p>
            <p>After Tax: <span class="amount" id="afterTax"></span></p>
        </div>

        <p>If you're Singapore tax resident only:</p>
        <div class="result" id="result">
            <p>Total Income: <span class="amount" id="sgTotalIncome"></span></p>
            <p>SG Tax <sup>[6]</sup>: <span id="sgTaxOnly"></span></p>
            <p>After Tax: <span class="amount" id="sgAfterTax"></span></p>
            <p>After Tax Diff: <span id="afterTaxDiff"></span></p>
        </div>

        <p>References</p>
        <div class="references result">
            <ul>
                <li>[1]: 是否能够独立计税请自行判断，比如 <a href="https://www.chinatax.gov.cn/n810341/n810765/n812188/n812950/c1201370/content.html">https://www.chinatax.gov.cn...</a></li>
                <li>[2]: 是否能够独立计税请自行判断，比如 <a href="https://www.gov.cn/zhengce/zhengceku/202308/content_6900234.htm">https://www.gov.cn/...</a></li>
                <li>[3]: For simplicity, the income tax on the tax subsidy itself for the following year is accounted for in the current year.</li>
                <li>[4]: Total Income = total package + tax subsidy</li>
                <li>[5]: CN tax rate <a href="https://cw.nwu.edu.cn/info/1009/2474.htm" target="_blank">https://cw.nwu.edu.cn/...</a></li>
                <li>[6]: SG tax rate <a href="https://www.iras.gov.sg/taxes/individual-income-tax/basics-of-individual-income-tax/tax-residency-and-tax-rates/individual-income-tax-rates" target="_blank">https://www.iras.gov.sg/...</a></li>
            </ul>
        </div>
    </div>

    <script>
        // Singapore tax brackets
        const sgTaxBrackets = [
            { upTo: 20000, rate: 0, baseTax: 0 },
            { upTo: 30000, rate: 0.02, baseTax: 0 },
            { upTo: 40000, rate: 0.035, baseTax: 200 },
            { upTo: 80000, rate: 0.07, baseTax: 550 },
            { upTo: 120000, rate: 0.115, baseTax: 3350 },
            { upTo: 160000, rate: 0.15, baseTax: 7950 },
            { upTo: 200000, rate: 0.18, baseTax: 13950 },
            { upTo: 240000, rate: 0.19, baseTax: 21150 },
            { upTo: 280000, rate: 0.195, baseTax: 28750 },
            { upTo: 320000, rate: 0.20, baseTax: 36550 },
            { upTo: 500000, rate: 0.22, baseTax: 44550 },
            { upTo: 1000000, rate: 0.23, baseTax: 84150 },
            { upTo: Infinity, rate: 0.24, baseTax: 199150 },
        ];
        
        // China tax brackets
        const cnTaxBrackets = [
            { upTo: 60000, rate: 0, reduct: 0 },
            { upTo: 36000 + 60000, rate: 0.03, reduct: 0 },
            { upTo: 144000 + 60000, rate: 0.10, reduct: 2520 },
            { upTo: 300000 + 60000, rate: 0.20, reduct: 16920 },
            { upTo: 420000 + 60000, rate: 0.25, reduct: 31920 },
            { upTo: 660000 + 60000, rate: 0.30, reduct: 52920 },
            { upTo: 960000 + 60000, rate: 0.35, reduct: 85920 },
            { upTo: Infinity, rate: 0.45, reduct: 181920 }
        ];

        // Helper function to format both SGD and CNY with commas
        function formatCurrencyCN(cnyValue, exchangeRate) {
            const sgdValue = cnyValue / exchangeRate;
            return formatCurrencies(sgdValue, cnyValue);
        }
        function formatCurrencySG(sgdValue, exchangeRate) {
            const cnyValue = sgdValue * exchangeRate;
            return formatCurrencies(sgdValue, cnyValue);
        }
        function formatCurrencies(sgdValue, cnyValue) {
            const format = (value, currency) => value.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0, currency, style: 'currency' });
            return `${format(sgdValue, 'SGD')} / ${format(cnyValue, 'CNY')}`;
        }

        // Calculate progressive tax
        function calculateProgressiveTax(income, taxBrackets) {
            let tax = 0;
            for (let i = 1; i < taxBrackets.length; i++) {
                const curr = taxBrackets[i], prev = taxBrackets[i - 1];
                const inRange = Math.min(curr.upTo, income) - prev.upTo;
                if (inRange > 0) {
                    tax += inRange * curr.rate;
                }
            }
            return tax;
        }

        function calculateCNTax(incomeInCNY, bonusInCNY, rsuSoldInCNY) {
            let income = incomeInCNY;
            let tax = 0;
            if (separatedBonusTax.checked) {
                income -= bonusInCNY
                tax += calculateProgressiveTax(bonusInCNY + 60000, cnTaxBrackets);
            }
            if (separatedRSUTax.checked) {
                income -= rsuSoldInCNY
                tax += calculateProgressiveTax(rsuSoldInCNY + 60000, cnTaxBrackets);
            }
            tax += calculateProgressiveTax(income, cnTaxBrackets);
            return tax;
        }

        // Main calculation logic
        function calculateTax() {
            const monthlyPay = parseFloat(document.getElementById('monthlyPay').value);
            const bonusMonths = parseFloat(document.getElementById('bonusMonths').value);
            const rsuSold = parseFloat(document.getElementById('rsuSold').value);
            const rate = parseFloat(document.getElementById('exchangeRate').value);
            const compRatio = parseFloat(compensationPercentage.value) / 100 * Number(employedDays.value) / 366;

            if (!monthlyPay || rsuSold < 0 || rate <= 0 || bonusMonths < 0 || compRatio < 0 || compRatio > 1) {
                for (const el of document.querySelectorAll('.amount')) el.innerText = formatCurrencySG(0, rate);
                return;
            }

            const basePay = monthlyPay * 12;
            const yearlyBonus = monthlyPay * bonusMonths;
            const cashPart = basePay + yearlyBonus;
            const compensation = cashPart * compRatio;
            const totalPackage = cashPart + rsuSold
            const totalIncome = totalPackage + compensation;

            // Both tax resident
            const sgTax = calculateProgressiveTax(totalIncome, sgTaxBrackets);
            const totalTaxInCNY = calculateCNTax(totalIncome * rate, yearlyBonus * rate, rsuSold * rate);
            const sgTaxInCNY = sgTax * rate;
            const cnSpecificTaxInCNY = totalTaxInCNY - sgTaxInCNY;

            // Only SG tax resident
            const sgTaxOnlyInSGD = calculateProgressiveTax(totalPackage, sgTaxBrackets)
            const afterTaxInSGD = totalIncome - totalTaxInCNY / rate;
            const sgAfterTaxInSGD = totalPackage - sgTaxOnlyInSGD;
            const afterTaxDiff = afterTaxInSGD - sgAfterTaxInSGD;

            // Display results
            document.getElementById('cashIncome').innerText = formatCurrencySG(cashPart, rate);
            document.getElementById('compensation').innerText = formatCurrencySG(compensation, rate);
            document.getElementById('totalIncome').innerText = formatCurrencySG(totalIncome, rate);
            document.getElementById('sgTax').innerText = formatCurrencySG(sgTax, rate);
            document.getElementById('totalTax').innerText = formatCurrencyCN(totalTaxInCNY, rate);
            document.getElementById('cnTax').innerText = formatCurrencyCN(cnSpecificTaxInCNY, rate);
            document.getElementById('afterTax').innerText = formatCurrencySG(afterTaxInSGD, rate);

            document.getElementById('sgTotalIncome').innerText = formatCurrencySG(totalPackage, rate);
            document.getElementById('sgTaxOnly').innerText = formatCurrencySG(sgTaxOnlyInSGD, rate);
            document.getElementById('sgAfterTax').innerText = formatCurrencySG(sgAfterTaxInSGD, rate);
            document.getElementById('afterTaxDiff').innerText = formatCurrencySG(afterTaxDiff, rate)
                + ` / ${(100 * afterTaxDiff / sgAfterTaxInSGD).toFixed(2)}%`;
        }

        // Initial calculation
        calculateTax();
        for (const input of document.querySelectorAll('input')) {
            input.addEventListener('input', () => calculateTax());
        }
    </script>
</body>
</html>
